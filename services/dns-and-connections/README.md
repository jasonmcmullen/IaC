# DNS and Remote Connections

DNS, reverse proxy, and secure remote access services.

## Services Included

### Pi-hole
DNS sinkhole for network-wide ad blocking and DNS management.

- **Image**: pihole/pihole:latest
- **Port**: 80 (Admin), 53 (DNS)
- **Features**: Ad blocking, DNS management, query logging
- **Admin**: http://localhost/admin

### NGINX Proxy Manager
Reverse proxy with GUI for SSL certificate management.

- **Image**: jc21/nginx-proxy-manager:latest
- **Port**: 81 (Admin), 80 (HTTP), 443 (HTTPS)
- **Default**: admin@example.com / changeme
- **Features**: Proxy hosts, SSL, access control

### Cloudflare DDNS
Auto-update DNS records for dynamic IP addresses.

- **Image**: favonia/cloudflare-ddns:latest
- **Requires**: Cloudflare account and API token
- **Purpose**: Keep DNS updated when IP changes

### Twingate (Optional)
VPN alternative for secure remote access.

- **Setup**: https://www.twingate.com/
- **Sponsor**: TechHut
- **Features**: Peer-to-peer VPN, secure remote access

## Configuration

### Pi-hole Setup
1. Access http://localhost/admin
2. Set admin password
3. Configure upstream DNS:
   - Quad9, OpenDNS, or Cloudflare
4. Add blocklists:
   - Commonly used lists available
5. Set router DNS to Pi-hole IP

### NGINX Proxy Manager Setup
1. Access http://localhost:81
2. Default: admin@example.com / changeme
3. **Change password immediately**
4. Navigate to "Proxy Hosts"
5. Add new proxy host:
   - Domain: vaultwarden.local
   - Upstream Host: vaultwarden
   - Upstream Port: 80

### Cloudflare DDNS Setup
1. Create Cloudflare account
2. Get API token from Cloudflare
3. Set environment variables:
   ```env
   CLOUDFLARE_API_TOKEN=xxx
   CLOUDFLARE_ZONE_ID=xxx
   CLOUDFLARE_DNS_RECORDS=example.com
   ```
4. Service auto-updates DNS

## Use Cases

### Local Network Access
- Pi-hole blocks ads network-wide
- NGINX Proxy Manager routes to services
- Access via: http://vaultwarden.local

### Remote Access with SSL
- NGINX Proxy Manager handles SSL
- Certificates auto-generated by Let's Encrypt
- Access via: https://vaultwarden.example.com

### Dynamic IP Support
- Cloudflare DDNS tracks IP changes
- Updates DNS automatically
- Cloudflare API handles changes

### VPN Alternative
- Twingate provides peer-to-peer VPN
- More secure than port forwarding
- Easier than traditional VPN setup

## SSL Certificate Management

### Automatic (Recommended)
NGINX Proxy Manager:
1. Create proxy host
2. Enable SSL tab
3. Select "Request new SSL certificate"
4. Let's Encrypt auto-generates in ~1 minute

### Manual Setup
```bash
# Using certbot
certbot certonly --standalone \
  -d example.com \
  -d vaultwarden.example.com

# Renewal automatic with systemd timer
sudo systemctl enable certbot.timer
```

## Access Control

Restrict who can access services:

1. In NGINX Proxy Manager
2. Click "Access Lists"
3. Create new list with Basic Auth
4. Assign to proxy host
5. Users must authenticate

Example:
- Username: admin
- Password: strong-password

## Network Diagram

```
Internet
   ↓
ISP Gateway (Router)
   ↓
Port Forward 80/443 → 192.168.1.100
   ↓
NGINX Proxy Manager
   ├→ vaultwarden.example.com → vaultwarden:80
   ├→ file-browser.example.com → file-browser:80
   └→ portainer.example.com → portainer:9000
   ↓
Services on homeserver network
```

## Advanced Features

### Multiple Domains
```
vaultwarden.example.com → vaultwarden service
file-browser.example.com → file-browser service
nextcloud.example.com → nextcloud service
```

### Path-based Routing
```
example.com/vaultwarden → vaultwarden service
example.com/files → file-browser service
example.com/portainer → portainer service
```

### Custom Headers
Add security headers:
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security: max-age=31536000

### Rate Limiting
Prevent brute force attacks:
1. Set rate limits per IP
2. Block repeated failed auth
3. Configure in access control

## Security Best Practices

1. **Always use HTTPS** for internet access
2. **Change default passwords** immediately
3. **Use strong passwords** for everything
4. **Enable 2FA** where available
5. **Monitor logs** for suspicious activity
6. **Keep containers updated** regularly
7. **Use firewall** to restrict access
8. **Regular backups** before exposing services
9. **Consider VPN** for extra security
10. **Implement rate limiting** on public services

## Monitoring

### Pi-hole Logs
```bash
docker logs pihole
```

### NGINX Logs
```bash
docker logs nginx-proxy-manager
```

### Test DNS Resolution
```bash
nslookup example.com 192.168.1.100
dig example.com @192.168.1.100
```

### Monitor Blocking
- Pi-hole admin: http://localhost/admin
- View queries and blocks
- Monitor lists

## Troubleshooting

### DNS not resolving
```bash
# Check Pi-hole running
docker ps | grep pihole

# Verify config
docker logs pihole

# Test locally
nslookup example.com 127.0.0.1
```

### SSL certificate issues
```bash
# Check NGINX logs
docker logs nginx-proxy-manager

# Force renewal
docker exec nginx-proxy-manager \
  /app/npm/scripts/letsencrypt-renew.sh
```

### Port forwarding not working
```bash
# Verify ports exposed
netstat -tulpn | grep LISTEN

# Check firewall
sudo ufw status

# Router port forwarding configured?
# Test from outside network
```

### DDNS not updating
```bash
# Check Cloudflare API token
docker logs cloudflare-ddns

# Verify IP change detected
curl ipinfo.io/ip
```

## Performance Optimization

### Pi-hole
- Use lightweight upstream DNS
- Limit query logging
- Regular gravity updates

### NGINX Proxy Manager
- Cache static content
- Compress responses
- Use keepalive connections

## Backup Strategy

Critical data:
- NGINX proxy hosts configuration
- SSL certificates (auto-renewable)
- Pi-hole settings and blocklists

Backup volumes:
```bash
./scripts/backup.sh
```

## Service Dependencies

Start in order:
1. **Pi-hole** - DNS foundation
2. **NGINX Proxy Manager** - Reverse proxy layer
3. **Cloudflare DDNS** - Dynamic DNS updates
4. **Other services** - Behind proxy

## Related Services

Works well with:
- Home Assistant (DNS automations)
- Twingate (VPN alternative)
- Monitoring services (track DNS queries)

## Alternative Services

- **AdGuard Home** - Alternative to Pi-hole
- **SWAG** - All-in-one reverse proxy
- **Traefik** - Modern reverse proxy
- **Tailscale** - Alternative VPN

---

**Last Updated**: December 30, 2025
